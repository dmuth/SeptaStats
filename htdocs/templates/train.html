
{% extends "base.html" %}

{% block title %}Train {{trainno}} of SEPTA Regional Rail - Septa Stats!{% endblock %}

{% block content %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/canvasjs/1.7.0/canvasjs.min.js" ></script>
<script src="/assets/script.js" ></script>
<script language="javascript">

/**
* Extract our stop history and minutes late from the data.
*
* @return array An array of stops and how many minutes late the train is at each stop.
*
*/
var getStops = function(data) {

	var retval = [];

	for (var k in data) {
		var stop = data[k];
		var nextstop = stop["nextstop"];
		var late = stop["Minutes Late"];

		var row = {
			nextstop: nextstop,
			late: late,
			};
		retval.push(row);

	}

	return(retval);

} // End of getTrains()


/**
* Convert our stop-based array into an array of data that Canvas can understand.
*/
var convertToCanvas = function(stops) {

	var retval = [];

	var row = {
		type: "area",  
		//showInLegend: true, 
		dataPoints: [],
		};

	for (var k in stops) {
		var stop = stops[k];

		row.dataPoints.push({
			y: parseInt(stop.late),
			label: stop.nextstop,
			});

	}

	retval.push(row);

	return(retval);

} // End of convertToCanvas()


var trainStatus = function(results) {

	var data = results["data"];

	var stops = getStops(data);
	var stop_data = convertToCanvas(stops);

	//
	// Finally, create the chart in CanvasJS
	//
	var chart = new CanvasJS.Chart("trainStatus", {
		title: {
			//text: "Top 10 Latest Trains Right Now",
			},
		animationDuration: 500,
		animationEnabled: true,
		axisX: {
			interval: 1,
			labelAngle: 45,
			},
		axisY: {
			suffix: " Min Late",
			},
		toolTip: {
			shared: true
			},
		data: stop_data,
	}
	);

	chart.render();

} // End of lineStatus()


/**
* This function goes through the lateness data and returns an array of 
*	data points by day for CanvasJS
*/
var getTrainHistory = function(data) {

	//
	// Our return value.  It holds arrays of stop and lateness info by day.
	//
	var retval = {
		"Minutes Late - Yesterday": [],
		"Minutes Late - 2 Days Ago": [],
		"Minutes Late - 3 Days Ago": [],
		"Minutes Late - 4 Days Ago": [],
		"Minutes Late - 5 Days Ago": [],
		"Minutes Late - 6 Days Ago": [],
		"Minutes Late - 7 Days Ago": [],
		};

	for (var k in data) {

		var current = data[k];
		var nextstop = current.nextstop;

		//
		// For each row, if a particular day's worth of data is present, pull it out
		// and store it in the appropriate array in retval.
		//
		for (var i in retval) {

			if (current[i]) {
				retval[i].push( {
					nextstop: nextstop,
					late: current[i],
					} );
			}
			
		}

	}

	return(retval);

} // End of getTrainHistory()


/**
* Convert a day's worth of stops and lateness into a group of datapoints for Canvas.
*/
var convertTrainHistoryDay = function(in_data, key) {

	var data = in_data[key];

	var retval = {
		type: "stackedArea",
		showInLegend: true,
		name: key,
		dataPoints: [],
		};

	for (var k in data) {
		var stop = data[k];
		retval.dataPoints.push({
			y: parseInt(stop.late),
			label: stop.nextstop,
			});

	}

	return(retval);

} // End of convertTrainHistoryDay()


/**
* Convert the results of getTrainHistory() into something that Canvas can understand.
*/
var convertTrainHistoryToCanvas = function(data) {

	var retval = [];

	retval.push(convertTrainHistoryDay(data, "Minutes Late - Yesterday"));
	retval.push(convertTrainHistoryDay(data, "Minutes Late - 2 Days Ago"));
	retval.push(convertTrainHistoryDay(data, "Minutes Late - 3 Days Ago"));
	retval.push(convertTrainHistoryDay(data, "Minutes Late - 4 Days Ago"));
	retval.push(convertTrainHistoryDay(data, "Minutes Late - 5 Days Ago"));
	retval.push(convertTrainHistoryDay(data, "Minutes Late - 6 Days Ago"));
	retval.push(convertTrainHistoryDay(data, "Minutes Late - 7 Days Ago"));

	return(retval);

} // End of convertTrainHistoryToCanvas()


/**
* Callback for the history of a specific train.
*/
var trainHistory = function(results) {

	var data = getTrainHistory(results["data"]);
	var stop_data = convertTrainHistoryToCanvas(data);

	//
	// Finally, create the chart in CanvasJS
	//
	var chart = new CanvasJS.Chart("trainHistory", {
		title: {
			//text: "Top 10 Latest Trains Right Now",
			},
		animationDuration: 500,
		animationEnabled: true,
		axisX: {
			interval: 1,
			labelAngle: 45,
			},
		axisY: {
			suffix: " Min Late",
			},
		toolTip: {
			shared: true
			},
		data: stop_data,
	}
	);

	chart.render();

} // End of lineStatus()


/**
* Populate our "trainLatest" with up to the minute stats on the current train.
*/
var trainLatest = function(results) {

	var id = "#trainLatest";
	var html = "";
	var data = results["data"][0];

	var trainno = data["trainno"];
	var source = data["source"];
	var dest = data["dest"];
	var nextstop = data["nextstop"];
	var late = data["late"];
	var time = data["time"];


	//
	// Get our date and time, with leading zeros
	//
	var date = new Date(time);
	var date_day = date.getFullYear() + "-" + ("0" + date.getMonth()).slice(-2) + "-" + ("0" + date.getDate()).slice(-2);
	var date_time = ("0" + date.getHours()).slice(-2) 
		+ ":" + ("0" + date.getMinutes()).slice(-2) 
		+ ":" + ("0" + date.getSeconds()).slice(-2);

	//
	// How old is the data?  If it's too old, then we'll let the user know.
	//
	var diff = (new Date() - date) / 1000;

	if (diff > 600) {
		html += '<div class="alert alert-block alert-info" role="alert">'
			+ 'This train data is more than 10 minutes old. Chances are that it has finished its trip.'
			+ '</div>';

	}


	//
	// Now create a row full of stats data.
	// On a desktop or laptop display, this should all fit in a single row.
	// On a mobile device, these should be neatly stacked.
	//
	html += '<div class="row">';

	html += '<div class="col-xs-6 col-md-2 current-cell">'
		+ '<div class="current-top">'
		+ 'Train #: ' 
		+ '</div>'
		+ '<div class="current-body" >'
		+ trainno 
		+ '</div>'
		+ '</div>';

	html += '<div class="col-xs-6 col-md-2 current-cell">'
		+ '<div class="current-top">'
		+ 'Minutes Late: ' 
		+ '</div>'
		+ '<div class="current-body" >'
		+ late 
		+ '</div>'
		+ '</div>';

	html += '<div class="col-xs-12 col-md-4 current-cell">'
		+ '<div class="current-top">'
		+ 'Next stop: ' 
		+ '</div>'
		+ '<div class="current-body" >'
		+ nextstop 
		+ '</div>'
		+ '</div>';

	html += '<div class="col-xs-6 col-md-2 current-cell">' 
		+ '<div class="current-top">'
		+ 'Route: ' 
		+ '</div>'
		+ '<div class="current-source">'
		+ source 
		+ '</div>'
		+ '<div class="current-dest">'
		+ ' to ' + dest 
		+ '</div>'
		+ '</div>';

	html += '<div class="col-xs-6 col-md-2 current-cell">'
		+ '<div class="current-top">'
		+ 'Last Updated: ' 
		+ '</div>'
		+ '<div class="current-update-time">'
		+ date_day
		+ '</div>'
		+ '<div class="current-update-time">'
		+ date_time
		+ '</div>'
		+ '</div>';

	html += '</div>'; // row

	$(id).html(html);

} // End of trainLatest()


$( document ).ready(function() {

	var url = "/api/current/train/" + "{{trainno}}" + "/latest";
	tryApi.try(url, trainLatest);

	var url = "/api/current/train/" + "{{trainno}}";
	tryApi.try(url, trainStatus);

	var url = "/api/current/train/" + "{{trainno}}" + "/history";
	tryApi.try(url, trainHistory);

	//
	// Check our width and set a handler to do the same
	//
	checkWidth.go();

	$( window ).resize(function() {
		checkWidth.go();
	});

});


</script>

<div class="row">
<div class="col-md-12">

<div id="trainLatest" >
</div>

</div><!-- /col -->
</div><!-- /row -->


<div class="row">
<div class="col-md-12">

<div class="alert alert-block alert-danger width-alert" role="alert">
Whoa there! Your screen is kinda narrow, and this may make some of the graphs look funny. 
<br/>
<br/>

You may want to turn your phone on its side for the best possible experience.

</div>

</div><!-- /col -->
</div><!-- /row -->


<div class="row">
<div class="col-md-12">

<h2>Lateness by Stop</h2>

<div id="trainStatus" style="height: 300px; width: 100%;">
{%include "lib/progress.html" %}
</div>

<div class="download-link">
<a href="/api/current/train/{{trainno}}" >Download this graph as JSON data</a>
</div>

<h2>Lateness Over The Last 7 Days</h2>
Note that some trains take different routes on different <em>days</em>. 
In those cases, this graph can look really weird.  There is little that
can be done about that until a date selector widget is built in.  For
more information, please <a href="/faq">check the faq</a>.
<br/>
<br/>

<div id="trainHistory" style="height: 300px; width: 100%;">
{%include "lib/progress.html" %}
</div>
<br/>

<div class="download-link">
<a href="/api/current/train/{{trainno}}/history" >Download this graph as JSON data</a>
</div>

</div><!-- /col -->
</div><!-- /row -->

{% endblock %}


