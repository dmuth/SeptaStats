
{% extends "base.html" %}

{% block title %}Septa Stats!{% endblock %}

{% block content %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/canvasjs/1.7.0/canvasjs.min.js" ></script>

<!--
TODO: 
X AJAX
X Put into a graph
- Extra graph http://septa.dmuth.org:8080/api/current/system/totals
- Handle errors: http://api.jquery.com/jquery.ajax/
- "loading" gif? (something in jQueryUI maybe?)

-->


<script language="javascript">

var graphStatus = function(results) {

	//
	// Loop through our time values and put the data into an array by train.
	//
	var trains = {};
	for (var k in results.data) {

		var row = results.data[k];
		var time = row["_time"];

		for (var i in row) {

			if (i == "_time") {
				continue;
			}

			var train = i;
			var late = row[i];

			//
			// The trains array gets one element per train,
			// and each element has an array of time and lateness.
			//
			if (!trains[train]) {
				trains[train] = [];
			}

			trains[train].push({time: time, late: late});

		}

	}

	//
	// Now turn that train data into datapoints for CanvasJS.
	//
	var train_data = [];
	for (var k in trains) {
		var train = trains[k];

		var row = {
			type: "stackedArea",  
			showInLegend: true, 
			name: k,
			dataPoints: [],
			};

		for (var i in train) {
			row.dataPoints.push({
				//x: train[i].time, 
				//x: 1,
				x: new Date(train[i].time),
				y: parseInt(train[i].late),
				});
		}

		train_data.push(row);

	}

	//
	// Finally, create the chart in CanvasJS
	//
	var chart = new CanvasJS.Chart("graphStatus", {
		title: {
			text: "Top 10 Latest Trains",
			},
		animationDuration: 500,
		animationEnabled: true,
		axisX: {
			intervalType: "minute",
			labelAngle: 45,
			},
		axisY: {
			suffix: " Min Late",
			},
		toolTip: {
			shared: true
			},
		data: train_data,
		});

	chart.render();

} // End of graphStatus()


$( document ).ready(function() {

	jQuery.ajax({
		url: "/api/current/system", 
		dataType: "json",
		success: graphStatus,
		});

});


</script>

<div id="graphStatus" style="height: 300px; width: 100%;"></div>


{% endblock %}

